{% extends "base.html" %}

{% block title %}Panel de Reportes{% endblock %}

{% block content %}
<!-- Panel de Filtros -->
<div class="bg-white p-6 rounded-xl shadow-md mb-8">
    <h2 class="text-2xl font-bold mb-4">Filtrar Incidencias</h2>
    <form method="POST" action="{{ url_for('main.index') }}">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
            <!-- Filtro Fecha Desde -->
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700">Desde</label>
                <select name="start_date" id="start_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">-- Seleccionar  --</option>
                    {% for d in available_start_dates %}
                        <option value="{{ d }}" {% if form_data.get('start_date','')==d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Filtro Fecha Hasta -->
            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">Hasta</label>
                <select id="end_date" name="end_date" {% if not available_end_dates or available_end_dates|length == 0 %}disabled{% endif %}>
                {% if available_end_dates %}
                    {% for d in available_end_dates %}
                    <option value="{{ d }}" {% if form_data.get('end_date','')==d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">-- Seleccione 'Desde' --</option>
                {% endif %}
                </select>
            </div>
            <!-- Filtro Distrito -->
            <div>
                <label for="distrito" class="block text-sm font-medium text-gray-700">Distrito</label>
                <select name="distrito" id="distrito" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">Todos</option>
                    {% for distrito in distritos %}
                        <option value="{{ distrito }}" {% if form_data.distrito == distrito %}selected{% endif %}>{{ distrito }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Filtro Causa -->
            <div class="lg:col-span-2">
                <label for="causa" class="block text-sm font-medium text-gray-700">Causa</label>
                <select name="causa" id="causa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">Todas</option>
                     {% for causa in causas %}
                        <option value="{{ causa }}" {% if form_data.causa == causa %}selected{% endif %}>{{ causa }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Botón de Filtrar -->
            <div class="md:col-start-4 lg:col-start-4">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Filtrar</button>
            </div>
        </div>
    </form>
</div>

<!-- Sección de Resultados -->
{% if incidents %}
<div class="bg-white p-6 rounded-xl shadow-md">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Resultados de la Búsqueda</h2>
        {% if incidents %}
        <a href="{{ url_for('main.download_xls', start_date=form_data.start_date, end_date=form_data.end_date, distrito=form_data.distrito, causa=form_data.causa) }}" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
            Descargar XLS
        </a>
        {% endif %}
    </div>
    <div class="overflow-auto max-h-[60vh]">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nro. Incidencia     </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Inicio     </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora de Inicio      </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Fin        </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora de Fin         </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Extracción          </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel de Tensión    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distrito            </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localidad           </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distribuidor        </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instalación         </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CT Involucrados     </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nises Involucrados  </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Potencia Involucrada</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Causa               </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reclamos            </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for incident in incidents %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ incident.nro_incidencia         }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.fecha_inicio_fmt      }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.hora_inicio_fmt       }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.fecha_fin_fmt         }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.hora_fin_fmt          }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.extraccion            }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.nivel_tension         }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.distrito              }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.localidad             }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.distribuidor          }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.instalacion           }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.ct_involucrados       }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.nises_involucrados    }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.potencia_involucrada  }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.descripcion_de_la_causa }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ incident.cantidad_de_reclamos  }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">No se encontraron incidencias con los filtros seleccionados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endif %}

<script>
(function(){
  const startSel = document.getElementById('start_date');
  const endSel   = document.getElementById('end_date');

  function resetEnd(msg) {
    endSel.innerHTML = "";
    const opt = document.createElement('option');
    opt.value = "";
    opt.textContent = msg || "-- Seleccione 'Desde' --";
    endSel.appendChild(opt);
    endSel.disabled = true;
  }

  async function loadEndDates(fromDate) {
    try {
      const res = await fetch(`/api/end_dates?from=${encodeURIComponent(fromDate)}`, {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const dates = Array.isArray(data.dates) ? data.dates : [];
      endSel.innerHTML = "";
      if (dates.length === 0) {
        resetEnd("-- Sin fechas válidas --");
        return;
      }
      for (const d of dates) {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        endSel.appendChild(opt);
      }
      endSel.disabled = false;
    } catch (e) {
      console.error(e);
      resetEnd("-- Error cargando fechas --");
    }
  }

  startSel.addEventListener('change', (ev) => {
    const v = (ev.target.value || "").trim();
    if (!v) { resetEnd(); return; }
    loadEndDates(v);
  });
})();
document.addEventListener("DOMContentLoaded", function () {
    fetch("/filtros_opciones")
        .then(res => res.json())
        .then(data => {
            const distritoSelect = document.getElementById("distrito");
            const causaSelect = document.getElementById("causa");

            if (!distritoSelect || !causaSelect) return;

            data.distritos.forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                opt.textContent = val;
                if (val === "{{ form_data.distrito }}") opt.selected = true;
                distritoSelect.appendChild(opt);
            });

            data.causas.forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                opt.textContent = val;
                if (val === "{{ form_data.causa }}") opt.selected = true;
                causaSelect.appendChild(opt);
            });
        });
});
</script>

{% endblock %}
